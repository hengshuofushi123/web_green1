# 广交绿证价格缓存功能说明

## 功能概述

为了提高用户体验和减少对外部API的频繁调用，我们为广交绿证价格数据实现了内存缓存机制。

## 实现特性

### 1. 缓存策略
- **缓存时长**: 24小时（86400秒）
- **存储位置**: 应用程序内存中
- **缓存范围**: 全局缓存，所有用户共享

### 2. 缓存逻辑
- **首次请求**: 从外部API获取数据，并存储到缓存中
- **后续请求**: 如果缓存未过期，直接返回缓存数据
- **缓存过期**: 超过24小时后，重新从API获取最新数据
- **应用重启**: 缓存会被清空，下次请求时重新获取

### 3. 缓存数据结构

```python
green_cert_price_cache = {
    'data': {                           # 缓存的价格数据
        'currentMonth': '8月',          # 当前月份
        'currentMonthPrice': 1.23,      # 当月价格（数值）
        'annualCumulativePrice': 2.45   # 年累计价格（数值）
    },
    'timestamp': datetime.now(),        # 缓存时间戳
    'cache_duration': 86400            # 缓存有效期（秒）
}
```

## 技术实现

### 1. 核心函数

#### `is_cache_valid()`
- 检查缓存是否有效（未过期）
- 比较当前时间与缓存时间戳的差值
- 返回布尔值表示缓存是否有效

#### `fetch_green_cert_price_from_api()`
- 从外部API获取最新的绿证价格数据
- 处理API响应并格式化数据
- 自动更新缓存数据和时间戳

#### `get_green_cert_price()`
- 主要的API端点函数
- 优先检查缓存，如果有效则返回缓存数据
- 缓存无效时调用API获取新数据

### 2. API响应格式

```json
{
    "success": true,
    "data": {
        "currentMonth": "8月",
        "currentMonthPrice": 1.23,
        "annualCumulativePrice": 2.45
    },
    "from_cache": true  // 标识数据来源：true=缓存，false=API
}
```

## 使用效果

### 1. 性能提升
- **响应速度**: 缓存命中时响应时间从秒级降低到毫秒级
- **网络负载**: 减少对外部API的调用频率
- **用户体验**: 页面加载更快，减少等待时间

### 2. 可靠性
- **容错处理**: API失败时仍可返回缓存数据（如果存在）
- **优雅降级**: 网络问题时显示友好的错误信息
- **自动恢复**: 网络恢复后自动获取最新数据

## 监控和调试

### 1. 缓存状态检查
- API响应中的 `from_cache` 字段可以判断数据来源
- 开发者可以通过日志监控缓存命中率

### 2. 手动清除缓存
如需手动清除缓存，可以重启应用程序或在代码中重置缓存变量：

```python
green_cert_price_cache['data'] = None
green_cert_price_cache['timestamp'] = None
```

## 注意事项

1. **内存缓存**: 缓存存储在应用程序内存中，应用重启后会丢失
2. **单实例**: 当前实现适用于单实例部署，多实例部署需要考虑分布式缓存
3. **数据一致性**: 24小时内的数据可能不是最新的，适合对实时性要求不高的场景
4. **内存使用**: 缓存数据量很小，对内存影响可忽略不计

## 未来优化方向

1. **可配置缓存时长**: 通过配置文件设置缓存有效期
2. **分布式缓存**: 使用Redis等外部缓存系统支持多实例部署
3. **缓存预热**: 应用启动时主动获取数据填充缓存
4. **缓存监控**: 添加缓存命中率统计和监控面板