{% extends 'dashboard_base.html' %}

{% block extra_css %}
<style>
    .loading-spinner {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 200px;
        flex-direction: column;
    }
    .spinner-border {
        width: 2rem;
        height: 2rem;
    }
    #chinaMap {
        width: 100%;
        height: 350px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <!-- KPI Cards -->
  <div class="row g-3" style="flex-shrink: 0;">
    <div class="col-12 col-md-2">
      <div class="card h-100">
        <div class="card-body">
          <h6 class="text-muted mb-1">项目总数</h6>
          <div class="mb-2"></div>
          <h3 class="mb-0">{{ total_projects or 0 }}</h3>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-2">
      <div class="card h-100">
        <div class="card-body">
          <h6 class="text-muted mb-1">累计核发量(万张)</h6>
          <div class="mb-2"></div>
          <h3 class="mb-0">{{ (total_issued|default(0))|round(1) }}</h3>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-2">
      <div class="card h-100">
        <div class="card-body">
          <h6 class="text-muted mb-1">累计成交量(万张)</h6>
          <div class="mb-2"></div>
          <h3 class="mb-0">{{ (total_sold|default(0))|round(1) }}</h3>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-2">
      <div class="card h-100">
        <div class="card-body">
          <h6 class="text-muted mb-1">库存量（万张）</h6>
          <div class="mb-2"></div>
          <h3 class="mb-0">{{ ((total_issued|default(0)) - (total_sold|default(0)))|round(1) }}</h3>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-2">
      <div class="card h-100">
        <div class="card-body">
          <h6 class="text-muted mb-1">平均成交单价(元/张)</h6>
          <div class="mb-2"></div>
          <h3 class="mb-0">{{ (avg_price|default(0))|round(1) }}</h3>
        </div>
      </div>
    </div>
    <!-- 广交绿证参考价格卡片 -->
    <div class="col-12 col-md-2">
      <div class="card h-100">
        <div class="card-body">
          <h6 class="text-muted mb-1">广交绿证价格（元/张）</h6>
          <div class="d-flex justify-content-between align-items-center mb-1">
            <h6 class="text-muted mb-0">当月</h6>
            <h3 class="mb-0" id="currentMonthPrice">加载中...</h3>
          </div>
          <div class="d-flex justify-content-between align-items-center">
            <h6 class="text-muted mb-0">年累</h6>
            <h3 class="mb-0" id="annualCumulativePrice">加载中...</h3>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Heat Map and Charts Row -->
  <div class="row g-3 mt-1">
    <!-- Heat Map -->
    <div class="col-12 col-lg-6">
      <div class="card h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">各省份成交量</h5>
          <div class="btn-group" role="group" aria-label="省份类型切换">
            <input type="radio" class="btn-check" name="provinceType" id="buyerProvince" value="buyer" checked>
            <label class="btn btn-outline-primary btn-sm" for="buyerProvince">买方省份</label>
            
            <input type="radio" class="btn-check" name="provinceType" id="sellerProvince" value="seller">
            <label class="btn btn-outline-primary btn-sm" for="sellerProvince">卖方省份</label>
          </div>
        </div>
        <div class="card-body p-2" style="height: calc(100% - 60px);">
          <div id="mapLoading" class="loading-spinner" style="display: none;">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">加载中...</span>
            </div>
            <p class="mt-3 text-muted">正在加载地图数据...</p>
          </div>
          <div id="chinaMap" style="width: 100%; height: 100%;"></div>
        </div>
      </div>
    </div>
    <!-- Monthly Trends Chart -->
    <div class="col-12 col-lg-6">
      <div class="card h-100">
        <div class="card-header">
          <h5 class="mb-0"><span id="currentYearTrend">2025年量价趋势</span></h5>
        </div>
        <div class="card-body">
          <!-- 成交价图表 -->
          <div class="mb-3">
            <h6 class="text-muted mb-2">月成交价</h6>
            <div style="height: 250px; position: relative;">
              <canvas id="monthlyPriceChart"></canvas>
            </div>
          </div>
          <!-- 成交量图表 -->
          <div>
            <h6 class="text-muted mb-2">月成交量</h6>
            <div style="height: 250px; position: relative;">
              <canvas id="monthlyVolumeChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Top Rankings Row -->
  <div class="row g-3 mt-4">
    <div class="col-12 col-lg-3">
      <div class="card h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span>省份成交Top10</span>
          <div class="btn-group" role="group" aria-label="省份类型切换">
            <input type="radio" class="btn-check" name="provinceTopType" id="buyerProvinceTop" value="buyer">
            <label class="btn btn-outline-primary btn-sm" for="buyerProvinceTop">买方省份</label>
            
            <input type="radio" class="btn-check" name="provinceTopType" id="sellerProvinceTop" value="seller" checked>
            <label class="btn btn-outline-primary btn-sm" for="sellerProvinceTop">卖方省份</label>
          </div>
        </div>
        <div class="card-body" style="overflow-y: auto; max-height: 400px;">
          <ul class="list-group list-group-flush" id="provinceTopList">
            {% for item in top_provinces or [] %}
            <li class="list-group-item d-flex justify-content-between align-items-center py-1">
              <span class="small">{{ item.name }}</span>
              <span class="fw-bold small">{{ (item.value or 0)|round(1) }}万张</span>
            </li>
            {% else %}
            <li class="list-group-item text-muted">暂无数据</li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>
    <div class="col-12 col-lg-3">
      <div class="card h-100">
        <div class="card-header">二级单位成交Top10</div>
        <div class="card-body" style="overflow-y: auto; max-height: 400px;">
          <ul class="list-group list-group-flush">
            {% for item in top_secondary_units or [] %}
            <li class="list-group-item d-flex justify-content-between align-items-center py-1">
              <span class="small">{{ item.name }}</span>
              <span class="fw-bold small">{{ (item.value or 0)|round(1) }}万张</span>
            </li>
            {% else %}
            <li class="list-group-item text-muted">暂无数据</li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>
    <div class="col-12 col-lg-3">
      <div class="card h-100">
        <div class="card-header">买方成交Top10</div>
        <div class="card-body" style="overflow-y: auto; max-height: 400px;">
          <ul class="list-group list-group-flush">
            {% for item in top_volume_trades or [] %}
            <li class="list-group-item py-1">
              <div class="d-flex justify-content-between align-items-start">
                <div class="small">
                  <div><strong>{{ item.buyer }}</strong></div>
                </div>
                <div class="text-end small">
                  <div class="fw-bold">{{ (item.quantity / 10000)|round(1) }}万张</div>
                  <div class="text-muted">均价: {{ item.price }}元/张</div>
                </div>
              </div>
            </li>
            {% else %}
            <li class="list-group-item text-muted">暂无数据</li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>
    <div class="col-12 col-lg-3">
      <div class="card h-100">
        <div class="card-header">成交价Top10</div>
        <div class="card-body" style="overflow-y: auto; max-height: 400px;">
          <ul class="list-group list-group-flush">
            {% for item in top_price_trades or [] %}
            <li class="list-group-item py-1">
              <div class="d-flex justify-content-between align-items-start">
                <div class="small">
                  <div><strong>买方:</strong> {{ item.buyer }}</div>
                  <div><strong>卖方:</strong> {{ item.seller }}</div>
                  <div class="text-muted">{{ item.platform }}</div>
                </div>
                <div class="text-end small">
                  <div class="fw-bold text-success">{{ item.price }}元/张</div>
                  <div class="text-muted">{{ item.quantity }}张</div>
                </div>
              </div>
            </li>
            {% else %}
            <li class="list-group-item text-muted">暂无数据</li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- ECharts -->
<script src="{{ url_for('static', filename='libs/echarts/echarts.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/chart.js') }}"></script>
<script>
// 全局变量
let chinaMapChart = null;
let volumeChart = null;
let priceChart = null;
let chartData = null;
let selectedMonth = null;
  // 页面加载完成后初始化
  $(document).ready(function() {
      loadChinaMapData();
      initVolumeChart();
      initPriceChart();
      loadProvinceData('buyer'); // 默认加载买方省份数据
      
      // 添加省份类型切换事件监听器
      $('input[name="provinceType"]').change(function() {
          const selectedType = $(this).val();
          currentProvinceType = selectedType;
          loadProvinceData(selectedType);
      });
    });
  
  // 加载中国地图数据
  function loadChinaMapData() {
    fetch('{{ url_for("static", filename="libs/echarts/china.json") }}')
      .then(response => response.json())
      .then(chinaJson => {
        echarts.registerMap('china', chinaJson);
        initHeatMap();
        loadProvinceData();
      })
      .catch(error => {
        console.error('加载地图数据失败:', error);
      });
  }
  
  // 初始化热力图
  function initHeatMap() {
    const mapContainer = document.getElementById('chinaMap');
    chinaMapChart = echarts.init(mapContainer);
    
    const option = {
      tooltip: {
        trigger: 'item',
        formatter: function(params) {
          return `${params.name}<br/>成交量: ${params.value ? params.value.toLocaleString() : 0} 万张`;
        }
      },
      visualMap: {
        show: false, // 设置为 false 即可隐藏该组件，但颜色映射依然生效
        min: 0,
        max: 1000,
        left: '5%',
        top: 'bottom',
        text: ['高', '低'],
        calculable: true,
        inRange: {
          // color: ['#E0F3F8', '#ABD9E9', '#74ADD1', '#4575B4', '#313695']
          color: ['#b5dbe5', '#d3e387', '#f7ee7a']
          // color: ['#f7ee7a', '#d3e387', '#b5dbe5']
          //color: ['#AED6F1', '#5DADE2','#3498DB']
        },
        textStyle: {
          color: '#555'
        }
      },
      series: [{
        name: '绿证成交量',
        type: 'map',
        map: 'china',
        roam: false,
        zoom: 1.2,
        label: {
          show: true,
          color: '#333',
          fontSize: 8
        },
        itemStyle: {
          borderColor: '#fff',
          borderWidth: 1
        },
        emphasis: {
          label: {
            color: '#000',
            fontSize: 10,
            fontWeight: 'bold'
          },
          itemStyle: {
            areaColor: '#FFD700'
          }
        },
        data: []
      }]
    };
    
    chinaMapChart.setOption(option);
    
    // 响应式调整
    window.addEventListener('resize', function() {
      if (chinaMapChart) {
        chinaMapChart.resize();
      }
    });
    
    // 添加鼠标离开事件监听器
    if (volumeChart && volumeChart.canvas) {
      volumeChart.canvas.addEventListener('mouseleave', () => {
        console.log('Volume chart mouseleave triggered'); // 调试信息
        // 鼠标离开成交量图表时，清除价格图表的悬浮效果
        setTimeout(() => {
          if (priceChart) {
            console.log('Clearing price chart tooltip'); // 调试信息
            // 完全重置tooltip状态
            priceChart.tooltip.opacity = 0;
            priceChart.tooltip._active = [];
            priceChart.setActiveElements([]);
            priceChart.tooltip.setActiveElements([]);
            
            // 强制隐藏tooltip DOM元素
            const tooltipEl = priceChart.canvas.parentNode.querySelector('.chartjs-tooltip');
            if (tooltipEl) {
              tooltipEl.style.opacity = '0';
              tooltipEl.style.display = 'none';
            }
            
            priceChart.update('none');
          }
        }, 10);
      });
    }
  }
  
  // 当前省份类型
  let currentProvinceType = 'buyer';
  
  // 加载省份数据
  function loadProvinceData(type = 'buyer') {
    const apiUrl = type === 'seller' ? '/dashboard/api/seller_province_transaction_data' : '/dashboard/api/province_transaction_data';
    
    fetch(apiUrl)
      .then(response => response.json())
      .then(data => {
        if (data.success && chinaMapChart) {
          // 过滤掉南海诸岛
          const filteredData = data.data.filter(item => item.name !== '南海诸岛');
          const maxValue = Math.max(...filteredData.map(item => item.value));
          chinaMapChart.setOption({
            visualMap: {
              max: maxValue
            },
            series: [{
              data: filteredData
            }]
          });
        }
      })
      .catch(error => {
        console.error('加载省份数据失败:', error);
      });
  }
  

  
  // 初始化成交量图表
  function initVolumeChart() {
    const ctx = document.getElementById('monthlyVolumeChart');
    if (!ctx) return;
    
    volumeChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: [],
        datasets: []
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              font: {
                size: 10
              }
            }
          },
          tooltip: {
            mode: 'index',
            intersect: false,
            callbacks: {
              label: function(context) {
                return context.dataset.label + ': ' + context.parsed.y.toLocaleString() + '万张';
              }
            }
          }
        },
        scales: {
          x: {
            title: {
              display: true,
              text: '月份',
              font: {
                size: 10
              }
            },
            ticks: {
              font: {
                size: 10
              }
            }
          },
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: '成交量（万张）',
              font: {
                size: 10
              }
            },
            ticks: {
              font: {
                size: 10
              }
            }
          }
        },
        onClick: (event, elements) => {
          if (elements.length > 0) {
            const dataIndex = elements[0].index;
            selectedMonth = dataIndex;
            highlightSelectedMonth();
          }
        },
        onHover: (event, elements) => {
          // 获取鼠标位置对应的数据索引
          const canvasPosition = Chart.helpers.getRelativePosition(event, priceChart);
          const dataX = priceChart.scales.x.getValueForPixel(canvasPosition.x);
          const dataIndex = Math.round(dataX);
          
          if (dataIndex >= 0 && dataIndex < priceChart.data.labels.length) {
            // 触发成交量图表的悬浮效果
            if (volumeChart) {
              const activeElements = [];
              for (let i = 0; i < volumeChart.data.datasets.length; i++) {
                activeElements.push({
                  datasetIndex: i,
                  index: dataIndex
                });
              }
              volumeChart.setActiveElements(activeElements);
              volumeChart.tooltip.setActiveElements(activeElements, {
                x: event.x || 0,
                y: event.y || 0
              });
              volumeChart.update('none');
            }
          } else {
            // 清除成交量图表的悬浮效果
            if (volumeChart) {
              volumeChart.setActiveElements([]);
              volumeChart.tooltip.setActiveElements([]);
              volumeChart.update('none');
            }
          }
        },
        onHover: (event, elements) => {
          // 获取鼠标位置对应的数据索引
          const canvasPosition = Chart.helpers.getRelativePosition(event, volumeChart);
          const dataX = volumeChart.scales.x.getValueForPixel(canvasPosition.x);
          const dataIndex = Math.round(dataX);
          
          if (dataIndex >= 0 && dataIndex < volumeChart.data.labels.length) {
            // 触发价格图表的悬浮效果
            if (priceChart) {
              const activeElements = [];
              for (let i = 0; i < priceChart.data.datasets.length; i++) {
                activeElements.push({
                  datasetIndex: i,
                  index: dataIndex
                });
              }
              priceChart.setActiveElements(activeElements);
              priceChart.tooltip.setActiveElements(activeElements, {
                x: event.x || 0,
                y: event.y || 0
              });
              priceChart.update('none');
            }
          } else {
            // 清除价格图表的悬浮效果
            if (priceChart) {
              priceChart.setActiveElements([]);
              priceChart.tooltip.setActiveElements([]);
              priceChart.update('none');
            }
          }
        }
      }
    });
    
    // 添加鼠标离开事件监听器
    if (volumeChart && volumeChart.canvas) {
      volumeChart.canvas.addEventListener('mouseleave', () => {
        console.log('Volume chart mouseleave triggered'); // 调试信息
        // 鼠标离开成交量图表时，清除价格图表的悬浮效果
        setTimeout(() => {
          if (priceChart) {
            console.log('Clearing price chart tooltip'); // 调试信息
            // 完全重置tooltip状态
            priceChart.tooltip.opacity = 0;
            priceChart.tooltip._active = [];
            priceChart.setActiveElements([]);
            priceChart.tooltip.setActiveElements([]);
            
            // 强制隐藏tooltip DOM元素
            const tooltipEl = priceChart.canvas.parentNode.querySelector('.chartjs-tooltip');
            if (tooltipEl) {
              tooltipEl.style.opacity = '0';
              tooltipEl.style.display = 'none';
            }
            
            priceChart.update('none');
          }
        }, 10);
      });
    }
  }
  
  // 初始化成交价图表
  function initPriceChart() {
    const ctx = document.getElementById('monthlyPriceChart');
    if (!ctx) return;
    
    priceChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: [],
        datasets: []
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              font: {
                size: 10
              }
            }
          },
          tooltip: {
            mode: 'index',
            intersect: false,
            callbacks: {
              label: function(context) {
                return context.dataset.label + ': ' + context.parsed.y.toLocaleString() + '元/张';
              }
            }
          }
        },
        scales: {
          x: {
            title: {
              display: true,
              text: '月份',
              font: {
                size: 10
              }
            },
            ticks: {
              font: {
                size: 10
              }
            }
          },
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: '成交价（元/张）',
              font: {
                size: 10
              }
            },
            ticks: {
              font: {
                size: 10
              }
            }
          }
        },
        onClick: (event, elements) => {
          if (elements.length > 0) {
            const dataIndex = elements[0].index;
            selectedMonth = dataIndex;
            highlightSelectedMonth();
          }
        },
        onHover: (event, elements) => {
          // 获取鼠标位置对应的数据索引
          const canvasPosition = Chart.helpers.getRelativePosition(event, volumeChart);
          const dataX = volumeChart.scales.x.getValueForPixel(canvasPosition.x);
          const dataIndex = Math.round(dataX);
          
          if (dataIndex >= 0 && dataIndex < volumeChart.data.labels.length) {
            // 触发价格图表的悬浮效果
            if (priceChart) {
              const activeElements = [];
              for (let i = 0; i < priceChart.data.datasets.length; i++) {
                activeElements.push({
                  datasetIndex: i,
                  index: dataIndex
                });
              }
              priceChart.setActiveElements(activeElements);
              priceChart.tooltip.setActiveElements(activeElements, {
                x: event.x || 0,
                y: event.y || 0
              });
              priceChart.update('none');
            }
          } else {
            // 清除价格图表的悬浮效果
            if (priceChart) {
              priceChart.setActiveElements([]);
              priceChart.tooltip.setActiveElements([]);
              priceChart.update('none');
            }
          }
        }
      }
    });
    
    // 添加鼠标离开事件监听器
    if (priceChart && priceChart.canvas) {
      priceChart.canvas.addEventListener('mouseleave', () => {
        console.log('Price chart mouseleave triggered'); // 调试信息
        // 鼠标离开价格图表时，清除成交量图表的悬浮效果
        setTimeout(() => {
          if (volumeChart) {
            console.log('Clearing volume chart tooltip'); // 调试信息
            // 完全重置tooltip状态
            volumeChart.tooltip.opacity = 0;
            volumeChart.tooltip._active = [];
            volumeChart.setActiveElements([]);
            volumeChart.tooltip.setActiveElements([]);
            
            // 强制隐藏tooltip DOM元素
            const tooltipEl = volumeChart.canvas.parentNode.querySelector('.chartjs-tooltip');
            if (tooltipEl) {
              tooltipEl.style.opacity = '0';
              tooltipEl.style.display = 'none';
            }
            
            volumeChart.update('none');
          }
        }, 10);
      });
    }
  }
  
  // 初始化成交价图表
  function initPriceChart() {
    const ctx = document.getElementById('monthlyPriceChart');
    if (!ctx) return;
    
    priceChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: [],
        datasets: []
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              font: {
                size: 10
              }
            }
          },
          tooltip: {
            mode: 'index',
            intersect: false,
            callbacks: {
              label: function(context) {
                return context.dataset.label + ': ' + context.parsed.y + '元/张';
              }
            }
          }
        },
        scales: {
          x: {
            title: {
              display: true,
              text: '月份',
              font: {
                size: 10
              }
            },
            ticks: {
              font: {
                size: 10
              }
            }
          },
          y: {
            beginAtZero: false,
            title: {
              display: true,
              text: '成交价（元/张）',
              font: {
                size: 10
              }
            },
            ticks: {
              font: {
                size: 10
              },
              maxTicksLimit: 8,
              padding: 10
            },
            grid: {
              drawBorder: true
            },
            position: 'left',
            width: 80
          }
        },
        onClick: (event, elements) => {
          if (elements.length > 0) {
            const dataIndex = elements[0].index;
            selectedMonth = dataIndex;
            highlightSelectedMonth();
          }
        },
        onHover: (event, elements) => {
          // 获取鼠标位置对应的数据索引
          const canvasPosition = Chart.helpers.getRelativePosition(event, priceChart);
          const dataX = priceChart.scales.x.getValueForPixel(canvasPosition.x);
          const dataIndex = Math.round(dataX);
          
          if (dataIndex >= 0 && dataIndex < priceChart.data.labels.length) {
            // 触发成交量图表的悬浮效果
            if (volumeChart) {
              const activeElements = [];
              for (let i = 0; i < volumeChart.data.datasets.length; i++) {
                activeElements.push({
                  datasetIndex: i,
                  index: dataIndex
                });
              }
              volumeChart.setActiveElements(activeElements);
              volumeChart.tooltip.setActiveElements(activeElements, {
                x: event.x || 0,
                y: event.y || 0
              });
              volumeChart.update('none');
            }
          } else {
            // 清除成交量图表的悬浮效果
            if (volumeChart) {
              volumeChart.setActiveElements([]);
              volumeChart.tooltip.setActiveElements([]);
              volumeChart.update('none');
            }
          }
        }
      }
    });
  }
  
  // 设置图表类型切换
  function setupChartTypeToggle() {
    // 这个函数现在不需要了，因为我们有两个独立的图表
  }
  
  // 更新成交量图表
  function updateVolumeChart() {
    if (!volumeChart || !chartData) return;
    
    const volumeLabels = chartData.volume_data.map(item => {
      const month = item.month.split('-')[1];
      return month + '月';
    });
    const volume2023 = chartData.volume_data.map(item => item.data_2023);
    const volume2024 = chartData.volume_data.map(item => item.data_2024);
    const volume2025 = chartData.volume_data.map(item => item.data_2025);
    
    volumeChart.data.labels = volumeLabels;
    volumeChart.data.datasets = [
      {
        label: '2023年生产',
        data: volume2023,
        backgroundColor: '#0d6efd',
        borderColor: '#0d6efd',
        borderWidth: 1
      },
      {
        label: '2024年生产',
        data: volume2024,
        backgroundColor: '#198754',
        borderColor: '#198754',
        borderWidth: 1
      },
      {
        label: '2025年生产',
        data: volume2025,
        backgroundColor: '#ffc107',
        borderColor: '#ffc107',
        borderWidth: 1
      }
    ];
    
    volumeChart.update();
  }
  
  // 更新成交价图表
  function updatePriceChart() {
    if (!priceChart || !chartData) return;
    
    const priceLabels = chartData.price_data.map(item => {
      const month = item.month.split('-')[1];
      return month + '月';
    });
    const price2023 = chartData.price_data.map(item => item.data_2023);
    const price2024 = chartData.price_data.map(item => item.data_2024);
    const price2025 = chartData.price_data.map(item => item.data_2025);
    
    priceChart.data.labels = priceLabels;
    priceChart.data.datasets = [
      {
        label: '2023年生产',
        data: price2023,
        borderColor: '#0d6efd',
        backgroundColor: 'rgba(13, 110, 253, 0.1)',
        tension: 0.25,
        fill: false,
        pointRadius: 4,
        pointHoverRadius: 6
      },
      {
        label: '2024年生产',
        data: price2024,
        borderColor: '#198754',
        backgroundColor: 'rgba(25, 135, 84, 0.1)',
        tension: 0.25,
        fill: false,
        pointRadius: 4,
        pointHoverRadius: 6
      },
      {
        label: '2025年生产',
        data: price2025,
        borderColor: '#ffc107',
        backgroundColor: 'rgba(255, 193, 7, 0.1)',
        tension: 0.25,
        fill: false,
        pointRadius: 4,
        pointHoverRadius: 6
      }
    ];
    
    priceChart.update();
  }
  
  // 高亮选中的月份（联动效果）
  function highlightSelectedMonth() {
    if (selectedMonth === null) return;
    
    // 更新成交量图表的高亮
    if (volumeChart) {
      const volumeDatasets = volumeChart.data.datasets.map(dataset => {
        const newDataset = {...dataset};
        newDataset.backgroundColor = dataset.backgroundColor;
        newDataset.borderColor = dataset.borderColor;
        newDataset.borderWidth = dataset.data.map((_, index) => index === selectedMonth ? 3 : 1);
        return newDataset;
      });
      volumeChart.data.datasets = volumeDatasets;
      volumeChart.update('none');
    }
    
    // 更新成交价图表的高亮
    if (priceChart) {
      const priceDatasets = priceChart.data.datasets.map(dataset => {
        const newDataset = {...dataset};
        newDataset.pointRadius = dataset.data.map((_, index) => index === selectedMonth ? 8 : 4);
        newDataset.pointHoverRadius = dataset.data.map((_, index) => index === selectedMonth ? 10 : 6);
        return newDataset;
      });
      priceChart.data.datasets = priceDatasets;
      priceChart.update('none');
    }
  }
  
  // 设置当前年份标题
  const currentYear = new Date().getFullYear();
  const yearTrendElement = document.getElementById('currentYearTrend');
  if (yearTrendElement) {
    yearTrendElement.textContent = currentYear + '年量价趋势';
  }
  
  // 获取广交绿证参考价格数据
  function loadGreenCertPrice() {
    fetch('/dashboard/api/green_cert_price')
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          const currentMonthElement = document.getElementById('currentMonthPrice');
          const annualCumulativeElement = document.getElementById('annualCumulativePrice');
          
          // 格式化价格，保留1位小数
          const currentPrice = parseFloat(data.data.currentMonthPrice).toFixed(1);
          const annualPrice = parseFloat(data.data.annualCumulativePrice).toFixed(1);
          
          if (currentMonthElement) {
            currentMonthElement.textContent = currentPrice;
          }
          if (annualCumulativeElement) {
            annualCumulativeElement.textContent = annualPrice;
          }
        } else {
          console.error('获取绿证价格失败:', data.message);
          const currentMonthElement = document.getElementById('currentMonthPrice');
          const annualCumulativeElement = document.getElementById('annualCumulativePrice');
          
          if (currentMonthElement) {
            currentMonthElement.textContent = '暂无数据';
          }
          if (annualCumulativeElement) {
            annualCumulativeElement.textContent = '暂无数据';
          }
        }
      })
      .catch(error => {
        console.error('获取绿证价格数据失败:', error);
        const currentMonthElement = document.getElementById('currentMonthPrice');
        const annualCumulativeElement = document.getElementById('annualCumulativePrice');
        
        if (currentMonthElement) {
          currentMonthElement.textContent = '网络错误';
        }
        if (annualCumulativeElement) {
          annualCumulativeElement.textContent = '网络错误';
        }
      });
  }
  
  // 加载绿证价格数据
  loadGreenCertPrice();
  
  // 省份成交Top10切换功能
  let currentProvinceTopType = 'seller';
  const topProvincesData = {
    seller: {{ top_provinces | tojson }},
    buyer: {{ top_buyer_provinces | tojson }}
  };
  
  function updateProvinceTopList(type) {
    const listElement = document.getElementById('provinceTopList');
    const data = topProvincesData[type] || [];
    
    if (data.length === 0) {
      listElement.innerHTML = '<li class="list-group-item text-muted">暂无数据</li>';
      return;
    }
    
    listElement.innerHTML = data.map(item => 
      `<li class="list-group-item d-flex justify-content-between align-items-center py-1">
        <span class="small">${item.name}</span>
        <span class="fw-bold small">${(item.value || 0).toFixed(1)}万张</span>
      </li>`
    ).join('');
  }
  
  // 省份成交Top10类型切换事件监听
  $('input[name="provinceTopType"]').change(function() {
    const selectedType = $(this).val();
    currentProvinceTopType = selectedType;
    updateProvinceTopList(selectedType);
  });
  
  // 获取真实数据并初始化图表
  fetch('/dashboard/api/dashboard_chart_data')
    .then(response => response.json())
    .then(data => {
      chartData = data;
       // 初始化图表数据
       updateVolumeChart();
       updatePriceChart();
    })
    .catch(error => {
      console.error('获取图表数据失败:', error);
      // 如果获取数据失败，显示错误信息或使用默认数据
      alert('获取图表数据失败，请刷新页面重试');
    });
</script>
{% endblock %}