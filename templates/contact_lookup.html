{% extends 'dashboard_base.html' %}
{% block page_title %}联系人查询{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <!-- 添加浮动提示框 -->
  <div id="toast-container" style="position: fixed; top: 20px; right: 20px; z-index: 9999;"></div>
  
  <div class="card">
    <div class="card-header">
      <h5 class="card-title">联系人查询 - 临时页面</h5>
      <p class="text-muted mb-0">输入联系人姓名查询对应的二级单位名称和密码</p>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6">
          <div class="mb-3">
            <label for="contactName" class="form-label">联系人姓名</label>
            <input type="text" class="form-control" id="contactName" placeholder="请输入联系人姓名">
          </div>
          <button type="button" class="btn btn-primary" id="searchBtn">查询</button>
          <button type="button" class="btn btn-secondary ms-2" id="clearBtn">清空</button>
        </div>
      </div>
      
      <!-- 查询结果区域 -->
      <div id="resultsSection" class="mt-4" style="display: none;">
        <h6>查询结果：</h6>
        <div class="table-responsive">
          <table class="table table-striped table-bordered">
            <thead class="table-dark">
              <tr>
                <th>二级单位名称</th>
                <th>联系人姓名</th>
                <th>密码</th>
              </tr>
            </thead>
            <tbody id="resultsTableBody">
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- 错误提示区域 -->
      <div id="errorSection" class="mt-4" style="display: none;">
        <div class="alert alert-danger" role="alert">
          <i class="fas fa-exclamation-triangle me-2"></i>
          <span id="errorMessage"></span>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const contactNameInput = document.getElementById('contactName');
    const searchBtn = document.getElementById('searchBtn');
    const clearBtn = document.getElementById('clearBtn');
    const resultsSection = document.getElementById('resultsSection');
    const errorSection = document.getElementById('errorSection');
    const resultsTableBody = document.getElementById('resultsTableBody');
    const errorMessage = document.getElementById('errorMessage');
    
    // 搜索按钮点击事件
    searchBtn.addEventListener('click', function() {
        const contactName = contactNameInput.value.trim();
        
        if (!contactName) {
            showError('请输入联系人姓名！');
            return;
        }
        
        // 显示加载状态
        searchBtn.disabled = true;
        searchBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>查询中...';
        
        // 隐藏之前的结果
        hideResults();
        
        // 发送查询请求
        fetch('/dashboard/api/contact-lookup', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                contact_name: contactName
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showError(data.error);
            } else {
                showResults(data.results);
            }
        })
        .catch(error => {
            showError('查询时发生网络错误，请重试！');
            console.error('Error:', error);
        })
        .finally(() => {
            // 恢复按钮状态
            searchBtn.disabled = false;
            searchBtn.innerHTML = '查询';
        });
    });
    
    // 清空按钮点击事件
    clearBtn.addEventListener('click', function() {
        contactNameInput.value = '';
        hideResults();
        contactNameInput.focus();
    });
    
    // 回车键搜索
    contactNameInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            searchBtn.click();
        }
    });
    
    // 显示查询结果
    function showResults(results) {
        hideError();
        
        resultsTableBody.innerHTML = '';
        
        results.forEach(result => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${result.secondary_unit}</td>
                <td>${result.contact_name || '未填写'}</td>
                <td>
                    <span class="badge bg-info fs-6">${result.password}</span>
                </td>
            `;
            resultsTableBody.appendChild(row);
        });
        
        resultsSection.style.display = 'block';
        
        // 显示成功提示
        showToast(`找到 ${results.length} 条记录`, 'success');
    }
    
    // 显示错误信息
    function showError(message) {
        hideResults();
        errorMessage.textContent = message;
        errorSection.style.display = 'block';
    }
    
    // 隐藏结果
    function hideResults() {
        resultsSection.style.display = 'none';
    }
    
    // 隐藏错误
    function hideError() {
        errorSection.style.display = 'none';
    }
    
    // 显示提示消息
    function showToast(message, type = 'info') {
        const toastContainer = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `alert alert-${type === 'success' ? 'success' : 'info'} alert-dismissible fade show`;
        toast.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        toastContainer.appendChild(toast);
        
        // 3秒后自动移除
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 3000);
    }
    
    // 页面加载完成后聚焦到输入框
    contactNameInput.focus();
});
</script>
{% endblock %}