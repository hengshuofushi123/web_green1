{% extends 'dashboard_base.html' %}
{% block page_title %}分月汇总{% endblock %}
{% block content %}
<div class="container-fluid py-4">
  <div class="card mb-3" style="position: relative; z-index: 10;">
    <div class="card-body">
      <form id="filterForm" class="row g-2 align-items-end">
        <!-- 筛选条件 -->
        <div class="col-sm-3 mb-2">
          <label class="form-label">二级单位</label>
          <select class="form-select" name="secondary_unit" id="secondary_unit">
            <option value="--所有--">--所有--</option>
            {% for unit in secondary_units %}
            <option value="{{ unit }}">{{ unit }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-sm-3 mb-2">
          <label class="form-label">所在省份</label>
          <select class="form-select" name="province" id="province">
            <option value="--所有--">--所有--</option>
            {% for province in provinces %}
            <option value="{{ province }}">{{ province }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-sm-3 mb-2">
          <label class="form-label">所在区域</label>
          <select class="form-select" name="region" id="region">
            <option value="--所有--">--所有--</option>
            {% for region in regions %}
            <option value="{{ region }}">{{ region }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-sm-3 mb-2">
          <label class="form-label">电源品种</label>
          <select class="form-select" name="power_type" id="power_type">
            <option value="--所有--">--所有--</option>
            {% for type in power_types %}
            <option value="{{ type }}">{{ type }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-sm-3 mb-2">
          <label class="form-label">项目投资口径</label>
          <select class="form-select" name="investment_scope" id="investment_scope">
            <option value="--所有--">--所有--</option>
            {% for scope in investment_scopes %}
            <option value="{{ scope }}">{{ scope }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-sm-3 mb-2">
          <label class="form-label">项目性质</label>
          <select class="form-select" name="project_nature" id="project_nature">
            <option value="--所有--">--所有--</option>
            {% for nature in project_natures %}
            <option value="{{ nature }}">{{ nature }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-sm-3 mb-2">
          <label class="form-label">是否特高压配套电源</label>
          <select class="form-select" name="is_uhv_support" id="is_uhv_support">
            <option value="--所有--">--所有--</option>
            <option value="1">是</option>
            <option value="0">否</option>
          </select>
        </div>
        <div class="col-sm-3 mb-2">
          <label class="form-label">是否含补贴</label>
          <select class="form-select" name="has_subsidy" id="has_subsidy">
            <option value="--所有--">--所有--</option>
            <option value="1">是</option>
            <option value="0">否</option>
          </select>
        </div>
        
        <!-- 电量生产时间选择器 -->
        <div class="col-sm-3 mb-2">
          <label class="form-label">电量生产时间</label>
          <div class="input-group">
            <input type="month" class="form-control" id="production_start_month" name="production_start_month" placeholder="开始月份">
            <span class="input-group-text">至</span>
            <input type="month" class="form-control" id="production_end_month" name="production_end_month" placeholder="结束月份">
          </div>
        </div>
        
        <!-- 交易时间选择器 -->
        <div class="col-sm-3 mb-2">
          <label class="form-label">交易时间</label>
          <div class="input-group">
            <input type="date" class="form-control" id="transaction_start_date" name="transaction_start_date" placeholder="开始日期">
            <span class="input-group-text">至</span>
            <input type="date" class="form-control" id="transaction_end_date" name="transaction_end_date" placeholder="结束日期">
          </div>
        </div>
        <div class="row align-items-end mb-2">
          <div class="col-md-6">
            <label class="form-label">项目列表 (共{{ projects|length }}个项目)</label>
            <div class="dropdown">
              <button class="btn btn-outline-secondary dropdown-toggle w-100 text-start" type="button" id="projectsDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                <span id="selectedProjectsText">选择项目...</span>
              </button>
              <div class="dropdown-menu w-100" style="max-height: 300px; overflow-y: auto; position: absolute; z-index: 1100;">
                <div class="px-3 py-2">
                  <input type="text" class="form-control form-control-sm" id="projectSearch" placeholder="搜索项目...">
                </div>
                <div class="px-3 py-1">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="selectAllProjects">
                    <label class="form-check-label" for="selectAllProjects">全选</label>
                  </div>
                </div>
                <div id="projectsList">
                  {% if projects %}
                    {% for project in projects %}
                    <div class="dropdown-item-text project-item">
                      <div class="form-check">
                        <input class="form-check-input project-checkbox" type="checkbox" value="{{ project.id }}" id="project_{{ project.id }}">
                        <label class="form-check-label" for="project_{{ project.id }}">{{ project.project_name }}</label>
                      </div>
                    </div>
                    {% endfor %}
                  {% else %}
                    <div class="dropdown-item-text text-muted">没有项目数据</div>
                  {% endif %}
                </div>
              </div>
            </div>
            <input type="hidden" name="projects" id="projects">
          </div>
          <div class="col-md-6 d-flex justify-content-start align-items-end">
            <div class="form-group">
              <button type="button" id="applyFilter" class="btn btn-primary">应用筛选</button>
              <button type="reset" class="btn btn-outline-secondary ms-2">重置</button>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>



  <div class="card" style="height: calc(100vh - 450px); display: flex; flex-direction: column;">
    <div class="card-header">
      <ul class="nav nav-tabs card-header-tabs" id="analysisTab" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="production-tab" data-bs-toggle="tab" data-bs-target="#production-tab-pane" type="button" role="tab" aria-controls="production-tab-pane" aria-selected="true">按生产月汇总</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="transaction-tab" data-bs-toggle="tab" data-bs-target="#transaction-tab-pane" type="button" role="tab" aria-controls="transaction-tab-pane" aria-selected="false">按交易月汇总</button>
        </li>
      </ul>
    </div>
    <div class="card-body" style="flex: 1; overflow: hidden; padding: 0;">
      <div id="loading" class="text-center py-5" style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10;">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">加载中...</span>
        </div>
        <p class="mt-2">数据加载中，请稍候...</p>
      </div>
      
      <div class="tab-content" id="analysisTabContent" style="height: 100%;">
        <!-- 交易结果分析（按电量生产年月）Tab页 -->
        <div class="tab-pane fade show active" id="production-tab-pane" role="tabpanel" aria-labelledby="production-tab" tabindex="0" style="height: 100%;">

          <div class="table-container" style="height: calc(100% - 60px); overflow: auto;">
            <table id="resultTable" class="table table-sm table-striped table-hover table-bordered mb-0">
              <thead class="bg-white">
                <tr>
                  <th rowspan="2" class="sticky-header">电量生产年月</th>
                  <th rowspan="2" class="sticky-header">总核发量</th>
                  <th rowspan="2" class="sticky-header">普通绿证</th>
                  <th rowspan="2" class="sticky-header">绿电绿证</th>
                  <th rowspan="2" class="sticky-header">核发平台售出量<br>（已划转量）</th>
                  <th rowspan="2" class="sticky-header">库存量</th>
                  <th colspan="3" class="sticky-header">绿证平台售出-单向挂牌</th>
                  <th colspan="3" class="sticky-header">绿证平台售出-双边线上</th>
                  <th colspan="3" class="sticky-header">绿证平台售出-双边线下</th>
                  <th colspan="3" class="sticky-header">北交平台售出</th>
                  <th colspan="3" class="sticky-header">广交平台售出</th>
                  <th colspan="3" class="sticky-header">交易平台售出汇总</th>
                  <th rowspan="2" class="sticky-header">售出比例<br>（划转口径）</th>
                  <th rowspan="2" class="sticky-header">售出比例<br>（交易口径）</th>
                </tr>
                <tr>
                  <th class="sticky-header-second">数量</th>
                  <th class="sticky-header-second">金额</th>
                  <th class="sticky-header-second">均价</th>
                  <th class="sticky-header-second">数量</th>
                  <th class="sticky-header-second">金额</th>
                  <th class="sticky-header-second">均价</th>
                  <th class="sticky-header-second">数量</th>
                  <th class="sticky-header-second">金额</th>
                  <th class="sticky-header-second">均价</th>
                  <th class="sticky-header-second">数量</th>
                  <th class="sticky-header-second">金额</th>
                  <th class="sticky-header-second">均价</th>
                  <th class="sticky-header-second">数量</th>
                  <th class="sticky-header-second">金额</th>
                  <th class="sticky-header-second">均价</th>
                  <th class="sticky-header-second">数量</th>
                  <th class="sticky-header-second">金额</th>
                  <th class="sticky-header-second">均价</th>
                </tr>
              </thead>
              <tbody id="resultBody">
                <tr>
                  <td colspan="26" class="text-center text-muted">请选择筛选条件并点击"应用筛选"按钮</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        
        <!-- 按交易时间汇总 Tab页 -->
        <div class="tab-pane fade" id="transaction-tab-pane" role="tabpanel" aria-labelledby="transaction-tab" tabindex="0" style="height: 100%;">

          <div class="table-container" style="height: calc(100% - 60px); overflow: auto;">
            <table id="transactionTable" class="table table-sm table-striped table-hover table-bordered mb-0">
              <thead class="bg-white">
                <tr>
                  <th rowspan="2" class="sticky-header">成交年月</th>
                  <th colspan="3" class="sticky-header">绿证平台售出-单向挂牌</th>
                  <th colspan="3" class="sticky-header">绿证平台售出-双边线上</th>
                  <th colspan="3" class="sticky-header">绿证平台售出-双边线下</th>
                  <th colspan="3" class="sticky-header">北交平台售出</th>
                  <th colspan="3" class="sticky-header">广交平台售出</th>
                  <th colspan="3" class="sticky-header">交易平台售出汇总</th>
                </tr>
                <tr>
                  <th class="sticky-header-second">数量</th>
                  <th class="sticky-header-second">金额</th>
                  <th class="sticky-header-second">均价</th>
                  <th class="sticky-header-second">数量</th>
                  <th class="sticky-header-second">金额</th>
                  <th class="sticky-header-second">均价</th>
                  <th class="sticky-header-second">数量</th>
                  <th class="sticky-header-second">金额</th>
                  <th class="sticky-header-second">均价</th>
                  <th class="sticky-header-second">数量</th>
                  <th class="sticky-header-second">金额</th>
                  <th class="sticky-header-second">均价</th>
                  <th class="sticky-header-second">数量</th>
                  <th class="sticky-header-second">金额</th>
                  <th class="sticky-header-second">均价</th>
                  <th class="sticky-header-second">数量</th>
                  <th class="sticky-header-second">金额</th>
                  <th class="sticky-header-second">均价</th>
                </tr>
              </thead>
              <tbody id="transactionBody">
                <tr>
                  <td colspan="19" class="text-center text-muted">请选择筛选条件并点击"应用筛选"按钮</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.project-item {
    padding: 0.25rem 0;
}
.project-item .form-check {
    margin-bottom: 0;
}
.dropdown-menu {
    padding: 0;
}
.dropdown-item-text {
    white-space: normal;
}

/* 表格样式 */
#resultTable {
    font-size: 0.875rem; /* 减小字体大小，相当于减小1号 */
}
#resultTable th {
    text-align: center;
    vertical-align: middle;
}
#resultTable td {
    text-align: right;
}
#resultTable td:first-child {
    text-align: center;
}

/* 按交易月汇总表样式 */
#transactionTable {
    font-size: 0.875rem; /* 减小字体大小，相当于减小1号 */
}
#transactionTable th {
    text-align: center;
    vertical-align: middle;
}
#transactionTable td {
    text-align: right;
}
#transactionTable td:first-child {
    text-align: center;
}

/* 表头冻结样式 */
.sticky-header {
    position: sticky;
    top: 0;
    background-color: #f8f9fa !important;
    height: 40px;
    border-bottom: none !important;
}
.sticky-header-second {
    position: sticky;
    top: 40px; /* 第二行粘在第一行下方 */
    background-color: #f8f9fa !important;
    height: 40px;
    border-top: none !important;
    border-bottom: 2px solid #dee2e6 !important;
}

/* 表格容器样式 */
.table-container {
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
}

/* 确保表格在容器中正确显示 */
#resultTable {
    margin-bottom: 0 !important;
}

/* 加载状态样式 */
#loading {
    background-color: rgba(255, 255, 255, 0.9);
    border-radius: 0.375rem;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    console.log('页面加载完成，开始初始化');
    
    // 初始化项目选择器
    initProjectSelector();
    
    function initProjectSelector() {
        // 初始化时全选所有项目
        $('.project-checkbox').prop('checked', true);
        updateSelectedProjects();
        updateSelectAllState();
        
        // 搜索功能
        $('#projectSearch').on('input', function() {
            const searchTerm = $(this).val().toLowerCase();
            $('.project-item').each(function() {
                const projectName = $(this).find('label').text().toLowerCase();
                if (projectName.includes(searchTerm)) {
                    $(this).show();
                } else {
                    $(this).hide();
                }
            });
        });
        
        // 全选功能
        $('#selectAllProjects').change(function() {
            const isChecked = $(this).is(':checked');
            $('.project-checkbox:visible').prop('checked', isChecked);
            updateSelectedProjects();
        });
        
        // 项目复选框变化
        $('.project-checkbox').change(function() {
            updateSelectedProjects();
            updateSelectAllState();
        });
        
        // 防止下拉菜单关闭
        $('.dropdown-menu').on('click', function(e) {
            e.stopPropagation();
        });
    }
    
    // Tab页切换事件
    $('.nav-link').on('click', function() {
        $('.nav-link').removeClass('active');
        $(this).addClass('active');
        $('.tab-pane').removeClass('show active');
        const target = $(this).data('bs-target');
        $(target).addClass('show active');
        // 移除切换tab时的数据重新计算，改为在应用筛选时同时计算两个表
    });
    
    // 获取按交易时间汇总数据函数
    function fetchTransactionTimeData() {
      const projectIds = $('#projects').val().split(',').filter(id => id);
      const filters = {
        secondary_unit: $('#secondary_unit').val(),
        province: $('#province').val(),
        region: $('#region').val(),
        power_type: $('#power_type').val(),
        investment_scope: $('#investment_scope').val(),
        project_nature: $('#project_nature').val(),
        is_uhv_support: $('#is_uhv_support').val(),
        has_subsidy: $('#has_subsidy').val(),
        projects: projectIds,
        production_start_month: $('#production_start_month').val(),
        production_end_month: $('#production_end_month').val(),
        transaction_start_date: $('#transaction_start_date').val(),
        transaction_end_date: $('#transaction_end_date').val()
      };

      $('#loading').show();
      $('#transactionBody').empty();
      
      $.ajax({
        url: '{{ url_for("dashboard.get_transaction_time_data") }}',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(filters),
        success: function(response) {
          console.log('获取到交易时间汇总数据:', response);
          $('#transactionBody').empty();
          
          if (response && response.length > 0) {
            // 创建汇总数据对象
            let summaryData = {
              unilateral_qty: 0,
              unilateral_amt: 0,
              online_qty: 0,
              online_amt: 0,
              offline_qty: 0,
              offline_amt: 0,
              beijing_qty: 0,
              beijing_amt: 0,
              guangzhou_qty: 0,
              guangzhou_amt: 0
            };
            
            // 先添加汇总行
            const summaryRow = `
              <tr class="table-secondary fw-bold">
                <td>汇总</td>
                <td id="t_sum_unilateral_qty">0</td>
                <td id="t_sum_unilateral_amt">0</td>
                <td id="t_sum_unilateral_avg">0</td>
                <td id="t_sum_online_qty">0</td>
                <td id="t_sum_online_amt">0</td>
                <td id="t_sum_online_avg">0</td>
                <td id="t_sum_offline_qty">0</td>
                <td id="t_sum_offline_amt">0</td>
                <td id="t_sum_offline_avg">0</td>
                <td id="t_sum_beijing_qty">0</td>
                <td id="t_sum_beijing_amt">0</td>
                <td id="t_sum_beijing_avg">0</td>
                <td id="t_sum_guangzhou_qty">0</td>
                <td id="t_sum_guangzhou_amt">0</td>
                <td id="t_sum_guangzhou_avg">0</td>
                <td id="t_sum_total_qty">0</td>
                <td id="t_sum_total_amt">0</td>
                <td id="t_sum_total_avg">0</td>
              </tr>
            `;
            $('#transactionBody').append(summaryRow);
            
            // 添加各月份数据行并累计汇总数据
            response.forEach(function(row) {
              // 计算交易平台售出汇总
              const totalQty = (parseFloat(row.unilateral_qty) || 0) + 
                              (parseFloat(row.online_qty) || 0) + 
                              (parseFloat(row.offline_qty) || 0) + 
                              (parseFloat(row.beijing_qty) || 0) + 
                              (parseFloat(row.guangzhou_qty) || 0);
              
              const totalAmt = (parseFloat(row.unilateral_amt) || 0) + 
                              (parseFloat(row.online_amt) || 0) + 
                              (parseFloat(row.offline_amt) || 0) + 
                              (parseFloat(row.beijing_amt) || 0) + 
                              (parseFloat(row.guangzhou_amt) || 0);
              
              const totalAvg = totalQty > 0 ? (totalAmt / totalQty).toFixed(2) : 0;
              
              const tr = `
                <tr>
                  <td>${row.transaction_year_month || ''}</td>
                  <td>${row.unilateral_qty || 0}</td>
                  <td>${row.unilateral_amt || 0}</td>
                  <td>${row.unilateral_avg || 0}</td>
                  <td>${row.online_qty || 0}</td>
                  <td>${row.online_amt || 0}</td>
                  <td>${row.online_avg || 0}</td>
                  <td>${row.offline_qty || 0}</td>
                  <td>${row.offline_amt || 0}</td>
                  <td>${row.offline_avg || 0}</td>
                  <td>${row.beijing_qty || 0}</td>
                  <td>${row.beijing_amt || 0}</td>
                  <td>${row.beijing_avg || 0}</td>
                  <td>${row.guangzhou_qty || 0}</td>
                  <td>${row.guangzhou_amt || 0}</td>
                  <td>${row.guangzhou_avg || 0}</td>
                  <td>${Math.round(totalQty)}</td>
                  <td>${totalAmt.toFixed(2)}</td>
                  <td>${totalAvg}</td>
                </tr>
              `;
              $('#transactionBody').append(tr);
              
              // 累加汇总数据
              summaryData.unilateral_qty += parseFloat(row.unilateral_qty) || 0;
              summaryData.unilateral_amt += parseFloat(row.unilateral_amt) || 0;
              summaryData.online_qty += parseFloat(row.online_qty) || 0;
              summaryData.online_amt += parseFloat(row.online_amt) || 0;
              summaryData.offline_qty += parseFloat(row.offline_qty) || 0;
              summaryData.offline_amt += parseFloat(row.offline_amt) || 0;
              summaryData.beijing_qty += parseFloat(row.beijing_qty) || 0;
              summaryData.beijing_amt += parseFloat(row.beijing_amt) || 0;
              summaryData.guangzhou_qty += parseFloat(row.guangzhou_qty) || 0;
              summaryData.guangzhou_amt += parseFloat(row.guangzhou_amt) || 0;
            });
            
            // 计算汇总行的均价
            const sumUnilateralAvg = summaryData.unilateral_qty > 0 ? (summaryData.unilateral_amt / summaryData.unilateral_qty).toFixed(2) : 0;
            const sumOnlineAvg = summaryData.online_qty > 0 ? (summaryData.online_amt / summaryData.online_qty).toFixed(2) : 0;
            const sumOfflineAvg = summaryData.offline_qty > 0 ? (summaryData.offline_amt / summaryData.offline_qty).toFixed(2) : 0;
            const sumBeijingAvg = summaryData.beijing_qty > 0 ? (summaryData.beijing_amt / summaryData.beijing_qty).toFixed(2) : 0;
            const sumGuangzhouAvg = summaryData.guangzhou_qty > 0 ? (summaryData.guangzhou_amt / summaryData.guangzhou_qty).toFixed(2) : 0;
            
            // 计算交易平台售出汇总
            const sumTotalQty = summaryData.unilateral_qty + summaryData.online_qty + summaryData.offline_qty + summaryData.beijing_qty + summaryData.guangzhou_qty;
            const sumTotalAmt = summaryData.unilateral_amt + summaryData.online_amt + summaryData.offline_amt + summaryData.beijing_amt + summaryData.guangzhou_amt;
            const sumTotalAvg = sumTotalQty > 0 ? (sumTotalAmt / sumTotalQty).toFixed(2) : 0;
            
            // 更新汇总行的数据
            $('#t_sum_unilateral_qty').text(Math.round(summaryData.unilateral_qty));
            $('#t_sum_unilateral_amt').text(summaryData.unilateral_amt.toFixed(2));
            $('#t_sum_unilateral_avg').text(sumUnilateralAvg);
            $('#t_sum_online_qty').text(Math.round(summaryData.online_qty));
            $('#t_sum_online_amt').text(summaryData.online_amt.toFixed(2));
            $('#t_sum_online_avg').text(sumOnlineAvg);
            $('#t_sum_offline_qty').text(Math.round(summaryData.offline_qty));
            $('#t_sum_offline_amt').text(summaryData.offline_amt.toFixed(2));
            $('#t_sum_offline_avg').text(sumOfflineAvg);
            $('#t_sum_beijing_qty').text(Math.round(summaryData.beijing_qty));
            $('#t_sum_beijing_amt').text(summaryData.beijing_amt.toFixed(2));
            $('#t_sum_beijing_avg').text(sumBeijingAvg);
            $('#t_sum_guangzhou_qty').text(Math.round(summaryData.guangzhou_qty));
            $('#t_sum_guangzhou_amt').text(summaryData.guangzhou_amt.toFixed(2));
            $('#t_sum_guangzhou_avg').text(sumGuangzhouAvg);
            $('#t_sum_total_qty').text(Math.round(sumTotalQty));
            $('#t_sum_total_amt').text(sumTotalAmt.toFixed(2));
            $('#t_sum_total_avg').text(sumTotalAvg);
          } else {
            $('#transactionBody').append('<tr><td colspan="19" class="text-center text-muted">暂无数据</td></tr>');
          }
          $('#loading').hide();
        },
        error: function(error) {
          console.error('获取交易时间汇总数据失败:', error);
          $('#transactionBody').append('<tr><td colspan="19" class="text-center text-danger">数据加载失败，请重试</td></tr>');
          $('#loading').hide();
        }
      });
    }
    
    function updateSelectedProjects() {
        const selectedIds = [];
        const selectedNames = [];
        
        $('.project-checkbox:checked').each(function() {
            selectedIds.push($(this).val());
            selectedNames.push($(this).next('label').text());
        });
        
        $('#projects').val(selectedIds.join(','));
        
        if (selectedNames.length === 0) {
            $('#selectedProjectsText').text('选择项目...');
        } else if (selectedNames.length === 1) {
            $('#selectedProjectsText').text(selectedNames[0]);
        } else {
            $('#selectedProjectsText').text(`已选择 ${selectedNames.length} 个项目`);
        }
    }
    
    function updateSelectAllState() {
        const totalVisible = $('.project-checkbox:visible').length;
        const checkedVisible = $('.project-checkbox:visible:checked').length;
        
        if (checkedVisible === 0) {
            $('#selectAllProjects').prop('indeterminate', false).prop('checked', false);
        } else if (checkedVisible === totalVisible) {
            $('#selectAllProjects').prop('indeterminate', false).prop('checked', true);
        } else {
            $('#selectAllProjects').prop('indeterminate', true);
        }
    }
    
    // 当筛选条件改变时，更新项目列表
    $('select:not(#projects)').change(function() {
      updateProjectsList();
    });
    
    // 初始化页面时不自动更新项目列表，保留服务器端渲染的初始项目
    // updateProjectsList();

    // 应用筛选按钮点击事件
    $('#applyFilter').click(function() {
      // 同时计算两个表的值
      fetchAnalysisData();
      fetchTransactionTimeData();
    });

    // 重置按钮点击事件
    $('button[type="reset"]').click(function() {
      setTimeout(function() {
        updateProjectsList();
        // 确保重置后项目列表也是全选状态
        setTimeout(function() {
          $('.project-checkbox').prop('checked', true);
          updateSelectedProjects();
          updateSelectAllState();
        }, 200);
      }, 100);
    });

    // 更新项目列表函数
    function updateProjectsList() {
      const filters = {
        secondary_unit: $('#secondary_unit').val(),
        province: $('#province').val(),
        region: $('#region').val(),
        power_type: $('#power_type').val(),
        investment_scope: $('#investment_scope').val(),
        project_nature: $('#project_nature').val(),
        is_uhv_support: $('#is_uhv_support').val(),
        has_subsidy: $('#has_subsidy').val()
      };
      
      $.ajax({
        url: '/dashboard/get_filtered_projects',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(filters),
        success: function(response) {
          console.log('AJAX成功，收到响应:', response);
          console.log('项目数量:', response.projects ? response.projects.length : 0);
          
          // 清空并重新填充项目列表
          $('#projectsList').empty();
          
          if (response.projects && response.projects.length > 0) {
            response.projects.forEach(function(project) {
              // 默认全选所有项目
              const projectItem = `
                <div class="dropdown-item-text project-item">
                  <div class="form-check">
                    <input class="form-check-input project-checkbox" type="checkbox" value="${project.id}" id="project_${project.id}" checked>
                    <label class="form-check-label" for="project_${project.id}">${project.project_name}</label>
                  </div>
                </div>
              `;
              $('#projectsList').append(projectItem);
            });
            console.log('已添加', response.projects.length, '个项目选项，默认全选');
            
            // 重新绑定事件
            $('.project-checkbox').off('change').on('change', function() {
              updateSelectedProjects();
              updateSelectAllState();
            });
            
            // 更新选中状态显示
            updateSelectedProjects();
            updateSelectAllState();
          } else {
            $('#projectsList').append('<div class="dropdown-item-text text-muted">没有符合条件的项目</div>');
            console.log('没有项目数据或项目列表为空');
            $('#selectedProjectsText').text('选择项目...');
            $('#projects').val('');
          }
        },
        error: function(xhr, status, error) {
          console.error('AJAX请求失败:', status, error);
          console.error('响应状态:', xhr.status);
          console.error('响应文本:', xhr.responseText);
        }
      });
    }

    // 获取分析数据函数
    function fetchAnalysisData() {
      const projectIds = $('#projects').val().split(',').filter(id => id);
      const filters = {
        secondary_unit: $('#secondary_unit').val(),
        province: $('#province').val(),
        region: $('#region').val(),
        power_type: $('#power_type').val(),
        investment_scope: $('#investment_scope').val(),
        project_nature: $('#project_nature').val(),
        is_uhv_support: $('#is_uhv_support').val(),
        has_subsidy: $('#has_subsidy').val(),
        projects: projectIds,
        production_start_month: $('#production_start_month').val(),
        production_end_month: $('#production_end_month').val(),
        transaction_start_date: $('#transaction_start_date').val(),
        transaction_end_date: $('#transaction_end_date').val()
      };

      $('#loading').show();
      $('#resultBody').empty();
      
      $.ajax({
        url: '{{ url_for("dashboard.get_analysis_data") }}',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(filters),
        success: function(response) {
          console.log('获取到分析数据:', response);
          $('#resultBody').empty();
          
          if (response && response.length > 0) {
            // 创建汇总数据对象
            let summaryData = {
              ordinary_green: 0,
              green_green: 0,
              issued_platform_sold: 0,
              unilateral_qty: 0,
              unilateral_amt: 0,
              online_qty: 0,
              online_amt: 0,
              offline_qty: 0,
              offline_amt: 0,
              beijing_qty: 0,
              beijing_amt: 0,
              guangzhou_qty: 0,
              guangzhou_amt: 0
            };
            
            // 先添加汇总行
            const summaryRow = `
              <tr class="table-secondary fw-bold">
                <td>汇总</td>
                <td id="sum_total_issued">0</td>
                <td id="sum_ordinary_green">0</td>
                <td id="sum_green_green">0</td>
                <td id="sum_issued_platform_sold">0</td>
                <td id="sum_inventory">0</td>
                <td id="sum_unilateral_qty">0</td>
                <td id="sum_unilateral_amt">0</td>
                <td id="sum_unilateral_avg">0</td>
                <td id="sum_online_qty">0</td>
                <td id="sum_online_amt">0</td>
                <td id="sum_online_avg">0</td>
                <td id="sum_offline_qty">0</td>
                <td id="sum_offline_amt">0</td>
                <td id="sum_offline_avg">0</td>
                <td id="sum_beijing_qty">0</td>
                <td id="sum_beijing_amt">0</td>
                <td id="sum_beijing_avg">0</td>
                <td id="sum_guangzhou_qty">0</td>
                <td id="sum_guangzhou_amt">0</td>
                <td id="sum_guangzhou_avg">0</td>
                <td id="sum_total_qty">0</td>
                <td id="sum_total_amt">0</td>
                <td id="sum_total_avg">0</td>
                <td id="sum_issued_ratio">0.0%</td>
                <td id="sum_trading_ratio">0.0%</td>
              </tr>
            `;
            $('#resultBody').append(summaryRow);
            
            // 添加各月份数据行并累计汇总数据
            response.forEach(function(row) {
              // 计算交易平台售出汇总
              const totalQty = (parseFloat(row.unilateral_qty) || 0) + 
                              (parseFloat(row.online_qty) || 0) + 
                              (parseFloat(row.offline_qty) || 0) + 
                              (parseFloat(row.beijing_qty) || 0) + 
                              (parseFloat(row.guangzhou_qty) || 0);
              
              const totalAmt = (parseFloat(row.unilateral_amt) || 0) + 
                              (parseFloat(row.online_amt) || 0) + 
                              (parseFloat(row.offline_amt) || 0) + 
                              (parseFloat(row.beijing_amt) || 0) + 
                              (parseFloat(row.guangzhou_amt) || 0);
              
              const totalAvg = totalQty > 0 ? (totalAmt / totalQty).toFixed(2) : 0;
              
              // 计算总核发量
              const ordinaryGreen = parseFloat(row.ordinary_green) || 0;
              const greenGreen = parseFloat(row.green_green) || 0;
              const totalIssued = ordinaryGreen + greenGreen;
              
              // 计算库存量
              const inventory = ordinaryGreen - (parseFloat(row.issued_platform_sold) || 0);
              
              // 计算售出比例
              const issuedRatio = ordinaryGreen > 0 ? ((parseFloat(row.issued_platform_sold) || 0) / ordinaryGreen * 100).toFixed(1) + '%' : '0.0%';
              const tradingRatio = ordinaryGreen > 0 ? (totalQty / ordinaryGreen * 100).toFixed(1) + '%' : '0.0%';
              
              const tr = `
                <tr>
                  <td>${row.production_year_month || ''}</td>
                  <td>${Math.round(totalIssued)}</td>
                  <td>${row.ordinary_green || 0}</td>
                  <td>${row.green_green || 0}</td>
                  <td>${row.issued_platform_sold || 0}</td>
                  <td>${Math.round(inventory)}</td>
                  <td>${row.unilateral_qty || 0}</td>
                  <td>${row.unilateral_amt || 0}</td>
                  <td>${row.unilateral_avg || 0}</td>
                  <td>${row.online_qty || 0}</td>
                  <td>${row.online_amt || 0}</td>
                  <td>${row.online_avg || 0}</td>
                  <td>${row.offline_qty || 0}</td>
                  <td>${row.offline_amt || 0}</td>
                  <td>${row.offline_avg || 0}</td>
                  <td>${row.beijing_qty || 0}</td>
                  <td>${row.beijing_amt || 0}</td>
                  <td>${row.beijing_avg || 0}</td>
                  <td>${row.guangzhou_qty || 0}</td>
                  <td>${row.guangzhou_amt || 0}</td>
                  <td>${row.guangzhou_avg || 0}</td>
                  <td>${Math.round(totalQty)}</td>
                  <td>${totalAmt.toFixed(2)}</td>
                  <td>${totalAvg}</td>
                  <td>${issuedRatio}</td>
                  <td>${tradingRatio}</td>
                </tr>
              `;
              $('#resultBody').append(tr);
              
              // 累加汇总数据
              summaryData.ordinary_green += parseFloat(row.ordinary_green) || 0;
              summaryData.green_green += parseFloat(row.green_green) || 0;
              summaryData.issued_platform_sold += parseFloat(row.issued_platform_sold) || 0;
              summaryData.unilateral_qty += parseFloat(row.unilateral_qty) || 0;
              summaryData.unilateral_amt += parseFloat(row.unilateral_amt) || 0;
              summaryData.online_qty += parseFloat(row.online_qty) || 0;
              summaryData.online_amt += parseFloat(row.online_amt) || 0;
              summaryData.offline_qty += parseFloat(row.offline_qty) || 0;
              summaryData.offline_amt += parseFloat(row.offline_amt) || 0;
              summaryData.beijing_qty += parseFloat(row.beijing_qty) || 0;
              summaryData.beijing_amt += parseFloat(row.beijing_amt) || 0;
              summaryData.guangzhou_qty += parseFloat(row.guangzhou_qty) || 0;
              summaryData.guangzhou_amt += parseFloat(row.guangzhou_amt) || 0;
            });
            
            // 计算汇总行的均价和比例
            const sumUnilateralAvg = summaryData.unilateral_qty > 0 ? (summaryData.unilateral_amt / summaryData.unilateral_qty).toFixed(2) : 0;
            const sumOnlineAvg = summaryData.online_qty > 0 ? (summaryData.online_amt / summaryData.online_qty).toFixed(2) : 0;
            const sumOfflineAvg = summaryData.offline_qty > 0 ? (summaryData.offline_amt / summaryData.offline_qty).toFixed(2) : 0;
            const sumBeijingAvg = summaryData.beijing_qty > 0 ? (summaryData.beijing_amt / summaryData.beijing_qty).toFixed(2) : 0;
            const sumGuangzhouAvg = summaryData.guangzhou_qty > 0 ? (summaryData.guangzhou_amt / summaryData.guangzhou_qty).toFixed(2) : 0;
            
            // 计算交易平台售出汇总
            const sumTotalQty = summaryData.unilateral_qty + summaryData.online_qty + summaryData.offline_qty + summaryData.beijing_qty + summaryData.guangzhou_qty;
            const sumTotalAmt = summaryData.unilateral_amt + summaryData.online_amt + summaryData.offline_amt + summaryData.beijing_amt + summaryData.guangzhou_amt;
            const sumTotalAvg = sumTotalQty > 0 ? (sumTotalAmt / sumTotalQty).toFixed(2) : 0;
            
            // 计算售出比例
            const sumIssuedRatio = summaryData.ordinary_green > 0 ? ((summaryData.issued_platform_sold / summaryData.ordinary_green) * 100).toFixed(1) + '%' : '0.0%';
            const sumTradingRatio = summaryData.ordinary_green > 0 ? ((sumTotalQty / summaryData.ordinary_green) * 100).toFixed(1) + '%' : '0.0%';
            
            // 计算总核发量汇总
            const sumTotalIssued = summaryData.ordinary_green + summaryData.green_green;
            
            // 计算库存量汇总
            const sumInventory = summaryData.ordinary_green - summaryData.issued_platform_sold;
            
            // 更新汇总行的数据
            $('#sum_total_issued').text(Math.round(sumTotalIssued));
            $('#sum_ordinary_green').text(Math.round(summaryData.ordinary_green));
            $('#sum_green_green').text(Math.round(summaryData.green_green));
            $('#sum_issued_platform_sold').text(Math.round(summaryData.issued_platform_sold));
            $('#sum_inventory').text(Math.round(sumInventory));
            $('#sum_unilateral_qty').text(Math.round(summaryData.unilateral_qty));
            $('#sum_unilateral_amt').text(summaryData.unilateral_amt.toFixed(2));
            $('#sum_unilateral_avg').text(sumUnilateralAvg);
            $('#sum_online_qty').text(Math.round(summaryData.online_qty));
            $('#sum_online_amt').text(summaryData.online_amt.toFixed(2));
            $('#sum_online_avg').text(sumOnlineAvg);
            $('#sum_offline_qty').text(Math.round(summaryData.offline_qty));
            $('#sum_offline_amt').text(summaryData.offline_amt.toFixed(2));
            $('#sum_offline_avg').text(sumOfflineAvg);
            $('#sum_beijing_qty').text(Math.round(summaryData.beijing_qty));
            $('#sum_beijing_amt').text(summaryData.beijing_amt.toFixed(2));
            $('#sum_beijing_avg').text(sumBeijingAvg);
            $('#sum_guangzhou_qty').text(Math.round(summaryData.guangzhou_qty));
            $('#sum_guangzhou_amt').text(summaryData.guangzhou_amt.toFixed(2));
            $('#sum_guangzhou_avg').text(sumGuangzhouAvg);
            $('#sum_total_qty').text(Math.round(sumTotalQty));
            $('#sum_total_amt').text(sumTotalAmt.toFixed(2));
            $('#sum_total_avg').text(sumTotalAvg);
            $('#sum_issued_ratio').text(sumIssuedRatio);
            $('#sum_trading_ratio').text(sumTradingRatio);
          } else {
            $('#resultBody').append('<tr><td colspan="24" class="text-center text-muted">暂无数据</td></tr>');
          }
          $('#loading').hide();
        },
        error: function(error) {
          console.error('获取分析数据失败:', error);
          $('#resultBody').append('<tr><td colspan="24" class="text-center text-danger">数据加载失败，请重试</td></tr>');
          $('#loading').hide();
        }
      });
    }
  });
</script>

{% endblock %}